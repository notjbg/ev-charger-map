<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Commercial EV Charger Map â€” Medium & Heavy-Duty</title>
<meta name="description" content="Interactive map of public DC fast charging stations for medium and heavy-duty electric vehicles across the United States. Powered by AFDC data.">
<meta property="og:title" content="ChargeFleet â€” Commercial EV Charger Map">
<meta property="og:description" content="Find DC fast charging stations for medium and heavy-duty electric vehicles. Filter by power level, connector type, vehicle class, and network.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://notjbg.github.io/ev-charger-map/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="ChargeFleet â€” Commercial EV Charger Map">
<meta name="twitter:description" content="Interactive map of 2,700+ commercial EV charging stations for MD/HD fleets.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ChargeFleet">
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22ChargeFleet%22%2C%22short_name%22%3A%22ChargeFleet%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0e17%22%2C%22theme_color%22%3A%22%230a0e17%22%7D">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "ChargeFleet",
  "alternateName": "Commercial EV Charger Map",
  "description": "Interactive map of public DC fast charging stations for medium and heavy-duty electric vehicles across the United States. Filter by power level, connector type, vehicle class, network, and funding source. Route corridor search for fleet planning.",
  "url": "https://notjbg.github.io/ev-charger-map/",
  "applicationCategory": "Transportation",
  "operatingSystem": "Web",
  "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"},
  "creator": {"@type": "Person", "name": "Jonah Berg", "url": "https://jonahberg.com"}
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "Where can I charge a medium or heavy-duty electric truck?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "ChargeFleet maps all public DC fast charging stations suitable for commercial electric vehicles across the US, including truck stops, travel centers, NEVI-funded highway corridor chargers, and high-power (350kW+) stations. Filter by vehicle class (MD Class 3-6 or HD Class 7-8), connector type (CCS, NACS, MCS), and minimum power level."
      }
    },
    {
      "@type": "Question",
      "name": "What is NEVI and how does it affect commercial EV charging?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "NEVI (National Electric Vehicle Infrastructure) is a $7.5 billion federal program funding EV charging stations along designated Alternative Fuel Corridors. These stations must have at least 150kW chargers and are spaced every 50 miles along interstate highways. ChargeFleet lets you filter specifically for NEVI and CFI (Charging and Fueling Infrastructure) funded stations."
      }
    },
    {
      "@type": "Question",
      "name": "What connectors do commercial electric trucks use?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Most commercial EVs use CCS (Combined Charging System) or NACS (North American Charging Standard, formerly Tesla) connectors. The emerging MCS (Megawatt Charging System) standard supports charging above 1MW for the heaviest vehicles like Class 8 trucks. ChargeFleet shows all connector types available at each station."
      }
    }
  ]
}
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
:root {
  --bg: #0a0e17;
  --bg-panel: #111827;
  --bg-card: #1a2332;
  --bg-hover: #1e2d3d;
  --border: #2a3a4a;
  --text: #e2e8f0;
  --text-dim: #8899aa;
  --text-bright: #f8fafc;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --green: #10b981;
  --amber: #f59e0b;
  --red: #ef4444;
  --purple: #8b5cf6;
  --cyan: #06b6d4;
  --orange: #f97316;
  --pink: #ec4899;
  --radius: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

/* Global transitions */
button, .chip, .btn, .btn-icon, .station-card, .info-card, .legend, a {
  transition: all 0.3s ease;
}

/* Skeleton loading animation */
@keyframes skeleton-pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}

.skeleton {
  background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-hover) 50%, var(--bg-card) 75%);
  background-size: 200% 100%;
  animation: skeleton-pulse 1.5s ease infinite;
  border-radius: var(--radius);
}

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  z-index: 1000;
  position: relative;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-bright);
  letter-spacing: -0.5px;
}

.logo span { color: var(--accent); }

.badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-live { background: rgba(16,185,129,0.15); color: var(--green); }

.header-stats {
  display: flex;
  gap: 20px;
  font-size: 13px;
  color: var(--text-dim);
}

.header-stats strong {
  color: var(--text-bright);
  font-variant-numeric: tabular-nums;
}

/* Layout */
.app {
  display: flex;
  height: calc(100vh - 56px);
}

/* Sidebar */
.sidebar {
  width: 360px;
  background: rgba(17,24,39,0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
  transition: width 0.3s ease, opacity 0.3s ease;
}

.sidebar.collapsed {
  width: 0;
  opacity: 0;
  pointer-events: none;
}

.sidebar-toggle {
  position: absolute;
  left: 360px;
  top: 70px;
  z-index: 1001;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  color: var(--text);
  width: 28px;
  height: 40px;
  border-radius: 0 var(--radius) var(--radius) 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: left 0.3s ease;
}

.sidebar.collapsed ~ .sidebar-toggle { left: 0; }

/* Search */
.search-container {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

.search-box {
  display: flex;
  gap: 8px;
}

.search-input {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  color: var(--text);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}

.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-dim); }

.btn {
  padding: 10px 16px;
  border-radius: var(--radius);
  border: none;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: var(--accent);
  color: white;
}

.btn-primary:hover { background: var(--accent-hover); }

.btn-secondary {
  background: var(--bg-card);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { background: var(--bg-hover); }

.btn-icon {
  padding: 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-icon:hover { background: var(--bg-hover); }

/* Filters */
.filters {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  overflow-y: auto;
  max-height: 45vh;
}

.filter-section {
  margin-bottom: 14px;
}

.filter-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-dim);
  margin-bottom: 8px;
}

.filter-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.chip {
  font-size: 12px;
  padding: 5px 10px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
  white-space: nowrap;
}

.chip:hover { border-color: var(--accent); color: var(--text); }

.chip.active {
  background: rgba(59,130,246,0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.chip .count {
  font-size: 10px;
  opacity: 0.7;
  margin-left: 4px;
}

/* Power range slider */
.power-range {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 6px;
}

.power-range input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  outline: none;
}

.power-range input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid var(--bg-panel);
}

.power-value {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  min-width: 60px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* Station list */
.station-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.station-list::-webkit-scrollbar { width: 6px; }
.station-list::-webkit-scrollbar-track { background: transparent; }
.station-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.station-card {
  padding: 12px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.station-card:hover { border-color: var(--accent); background: var(--bg-hover); transform: translateX(2px) scale(1.01); }
.station-card.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }

.station-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-bright);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.station-address {
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 8px;
}

.station-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.tag {
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 4px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.tag-power { background: rgba(59,130,246,0.15); color: var(--accent); }
.tag-network { background: rgba(139,92,246,0.15); color: var(--purple); }
.tag-connector { background: rgba(6,182,212,0.15); color: var(--cyan); }
.tag-hd { background: rgba(249,115,22,0.15); color: var(--orange); }
.tag-md { background: rgba(245,158,11,0.15); color: var(--amber); }
.tag-nevi { background: rgba(16,185,129,0.15); color: var(--green); }
.tag-truck { background: rgba(236,72,153,0.15); color: var(--pink); }
.tag-mcs { background: rgba(239,68,68,0.15); color: var(--red); }

/* Map */
.map-container {
  flex: 1;
  position: relative;
}

#map {
  width: 100%;
  height: 100%;
  background: var(--bg);
}

/* Dark map tiles */
.leaflet-tile-pane { filter: invert(1) hue-rotate(180deg) brightness(0.85) contrast(1.1) saturate(0.3); }

/* Map popup */
.leaflet-popup-content-wrapper {
  background: var(--bg-card) !important;
  color: var(--text) !important;
  border-radius: var(--radius) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
}

.leaflet-popup-tip { background: var(--bg-card) !important; }

.leaflet-popup-content {
  margin: 14px 16px !important;
  font-size: 13px !important;
  line-height: 1.5 !important;
  min-width: 260px !important;
}

.popup-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-bright);
  margin-bottom: 4px;
}

.popup-address {
  color: var(--text-dim);
  font-size: 12px;
  margin-bottom: 10px;
}

.popup-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 10px;
}

.popup-item {
  display: flex;
  flex-direction: column;
}

.popup-item-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  font-weight: 600;
}

.popup-item-value {
  font-size: 13px;
  color: var(--text-bright);
  font-weight: 500;
}

.popup-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 8px;
}

.popup-hours {
  font-size: 12px;
  color: var(--text-dim);
  border-top: 1px solid var(--border);
  padding-top: 8px;
  margin-top: 4px;
}

.popup-pricing {
  font-size: 12px;
  color: var(--green);
  font-weight: 500;
}

.popup-directions {
  display: inline-block;
  margin-top: 8px;
  font-size: 12px;
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
}

.popup-directions:hover { text-decoration: underline; }

/* Loading overlay */
.loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(10,14,23,0.85);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden { opacity: 0; pointer-events: none; }

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  margin-top: 16px;
  font-size: 14px;
  color: var(--text-dim);
}

.loading-progress {
  margin-top: 8px;
  font-size: 12px;
  color: var(--text-dim);
  font-variant-numeric: tabular-nums;
}

/* Legend */
.legend {
  position: absolute;
  bottom: 24px;
  right: 16px;
  background: rgba(17,24,39,0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 16px;
  z-index: 800;
  font-size: 12px;
  box-shadow: var(--shadow);
  min-width: 160px;
}

.legend-title {
  font-weight: 700;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-dim);
  margin-bottom: 8px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
  color: var(--text);
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
  border: 2px solid rgba(255,255,255,0.2);
}

/* Info panel on map */
.map-info {
  position: absolute;
  top: 12px;
  right: 16px;
  z-index: 800;
  display: flex;
  gap: 8px;
}

.info-card {
  background: rgba(17,24,39,0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 14px;
  box-shadow: var(--shadow);
  text-align: center;
}

.info-card-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-bright);
  font-variant-numeric: tabular-nums;
}

.info-card-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  font-weight: 600;
}

/* Cluster styles */
.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
  background: rgba(59,130,246,0.3) !important;
}

.marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
  background: var(--accent) !important;
  color: white !important;
  font-weight: 700 !important;
  font-size: 13px !important;
}

/* Empty state */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  text-align: center;
}

.empty-state-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.empty-state-text { font-size: 13px; color: var(--text-dim); }

/* Error toast */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 1px solid var(--red);
  border-radius: var(--radius);
  padding: 12px 20px;
  color: var(--text);
  font-size: 13px;
  z-index: 9999;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease;
  max-width: 90vw;
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* Mobile */
@media (max-width: 768px) {
  .sidebar {
    position: absolute;
    z-index: 1000;
    width: 100%;
    height: 50vh;
    bottom: 0;
    top: auto;
    border-right: none;
    border-top: 1px solid var(--border);
    border-radius: 16px 16px 0 0;
  }

  .sidebar.collapsed { height: 0; }

  .sidebar-toggle {
    left: 50%;
    transform: translateX(-50%);
    top: auto;
    bottom: calc(50vh + 4px);
    border-radius: var(--radius) var(--radius) 0 0;
    width: 48px;
    height: 28px;
  }

  .sidebar.collapsed ~ .sidebar-toggle {
    left: 50%;
    bottom: 4px;
  }

  .header-stats { display: none; }

  .map-info { top: 8px; right: 8px; }
  .info-card { padding: 6px 10px; }
  .info-card-value { font-size: 14px; }

  .legend { bottom: 8px; right: 8px; }

  .filters { max-height: 30vh; }
}

/* Leaflet overrides */
.leaflet-control-zoom a {
  background: var(--bg-panel) !important;
  color: var(--text) !important;
  border-color: var(--border) !important;
}

.leaflet-control-zoom a:hover {
  background: var(--bg-hover) !important;
}

.leaflet-control-attribution {
  background: rgba(10,14,23,0.8) !important;
  color: var(--text-dim) !important;
  font-size: 10px !important;
}

.leaflet-control-attribution a { color: var(--text-dim) !important; }

/* Custom marker styles */
.custom-marker {
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  transition: transform 0.2s;
}

.custom-marker:hover { transform: scale(1.3); }

/* Geolocation button */
.locate-btn {
  position: absolute;
  bottom: 24px;
  left: 16px;
  z-index: 800;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  color: var(--text);
  cursor: pointer;
  font-size: 14px;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
}

.locate-btn:hover { background: var(--bg-hover); border-color: var(--accent); }

.welcome-card {
  position: absolute;
  bottom: 70px;
  left: 16px;
  z-index: 800;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  max-width: 380px;
}

@media (max-width: 768px) {
  .welcome-card { display: none; }
  .drawer-handle { display: block !important; }
  .locate-btn { bottom: 12px; left: 8px; padding: 8px 10px; font-size: 12px; }
  .leaflet-popup-content-wrapper { max-width: 280px !important; }
  .leaflet-popup-content { max-width: 260px !important; font-size: 13px !important; }
  .popup-grid { grid-template-columns: 1fr !important; }
}

.drawer-handle {
  display: none;
  padding: 8px 0 4px;
  text-align: center;
  cursor: grab;
  touch-action: none;
}

.drawer-handle-bar {
  width: 36px;
  height: 4px;
  background: var(--text-dim);
  border-radius: 2px;
  margin: 0 auto;
  opacity: 0.6;
}

/* Station count in sidebar header */
.sidebar-header {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.sidebar-header-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.sidebar-header-count {
  font-size: 12px;
  color: var(--text-dim);
  font-variant-numeric: tabular-nums;
}

.sort-select {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 12px;
  padding: 4px 8px;
  outline: none;
}

/* â”€â”€ Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-panel {
  position: absolute;
  top: 0;
  right: 0;
  width: 380px;
  height: 100%;
  background: rgba(17,24,39,0.85);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-left: 1px solid var(--border);
  z-index: 900;
  transform: translateX(100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  box-shadow: -4px 0 24px rgba(0,0,0,0.4);
}

.detail-panel.open { transform: translateX(0); }

.detail-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.detail-panel-close {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.2s;
}

.detail-panel-close:hover { background: var(--bg-hover); border-color: var(--accent); }

.detail-panel-body { padding: 20px; flex: 1; }

.detail-station-name {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-bright);
  margin-bottom: 6px;
  line-height: 1.3;
}

.detail-address {
  font-size: 13px;
  color: var(--text-dim);
  margin-bottom: 16px;
}

.detail-network-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(139,92,246,0.15);
  color: var(--purple);
  margin-bottom: 16px;
}

.detail-section-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  margin-bottom: 8px;
  margin-top: 16px;
}

.detail-connectors {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
}

.connector-badge {
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid transparent;
}

.connector-badge.power-ultra { background: rgba(59,130,246,0.15); color: #60a5fa; border-color: rgba(59,130,246,0.3); }
.connector-badge.power-fast { background: rgba(16,185,129,0.15); color: #34d399; border-color: rgba(16,185,129,0.3); }
.connector-badge.power-standard { background: rgba(245,158,11,0.15); color: #fbbf24; border-color: rgba(245,158,11,0.3); }

.detail-hours {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: var(--bg-card);
  border-radius: var(--radius);
  font-size: 13px;
  margin-bottom: 12px;
}

.hours-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.hours-dot.open { background: var(--green); box-shadow: 0 0 6px var(--green); }
.hours-dot.unknown { background: var(--text-dim); }

.detail-truck-access {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: rgba(249,115,22,0.1);
  border: 1px solid rgba(249,115,22,0.3);
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  color: var(--orange);
  margin-bottom: 12px;
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}

.detail-grid-item {
  background: var(--bg-card);
  padding: 10px 12px;
  border-radius: var(--radius);
}

.detail-grid-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  font-weight: 600;
}

.detail-grid-value {
  font-size: 14px;
  color: var(--text-bright);
  font-weight: 600;
  margin-top: 2px;
}

.detail-actions {
  display: flex;
  gap: 8px;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.detail-actions .btn { flex: 1; justify-content: center; }

.detail-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
}

.detail-fleet-section {
  margin-top: 16px;
  padding: 14px;
  background: rgba(59,130,246,0.08);
  border: 1px solid rgba(59,130,246,0.2);
  border-radius: var(--radius);
}

.fleet-vehicle-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  font-size: 13px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.fleet-vehicle-row:last-child { border-bottom: none; }

.fleet-vehicle-name { color: var(--text); font-weight: 500; }
.fleet-vehicle-time { color: var(--accent); font-weight: 600; }

/* Fleet mode NEVI glow */
.fleet-mode-active .custom-marker.nevi-station div {
  box-shadow: 0 0 12px 4px rgba(16,185,129,0.6) !important;
}

.fleet-mode-badge {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
  background: rgba(249,115,22,0.15);
  color: var(--orange);
  border: 1px solid rgba(249,115,22,0.3);
  margin-left: 8px;
}

@media (max-width: 768px) {
  .detail-panel {
    width: 100%;
    height: 70vh;
    top: auto;
    bottom: 0;
    transform: translateY(100%);
    border-left: none;
    border-top: 1px solid var(--border);
    border-radius: 16px 16px 0 0;
  }
  .detail-panel.open { transform: translateY(0); }
}
</style>
</head>
<body>

<div class="header" role="banner">
  <div class="header-left">
    <div class="logo">âš¡ <span>Charge</span>Fleet</div>
    <span class="badge badge-live">LIVE DATA</span>
    <div style="display:flex;gap:4px;margin-left:12px;">
      <button class="btn-icon" id="viewMarkers" title="Marker view" style="font-size:12px;padding:6px 10px;background:var(--accent);color:white;">ğŸ“</button>
      <button class="btn-icon" id="viewHeat" title="Heat map" style="font-size:12px;padding:6px 10px;">ğŸ”¥</button>
      <button class="btn-icon" id="fleetModeBtn" title="Fleet Mode â€” filter for commercial trucks" style="font-size:12px;padding:6px 10px;margin-left:4px;">ğŸš›</button>
    </div>
  </div>
  <div class="header-stats">
    <span>Stations: <strong id="totalStations">â€”</strong></span>
    <span>Ports: <strong id="totalPorts">â€”</strong></span>
    <span>Networks: <strong id="totalNetworks">â€”</strong></span>
    <span>Last Updated: <strong id="lastUpdated">â€”</strong></span>
    <button class="btn-icon" id="statsToggle" title="Station statistics" style="font-size:12px;padding:6px 10px;margin-left:8px;">ğŸ“Š</button>
  </div>
</div>

<!-- Stats Dashboard -->
<div id="statsDashboard" style="display:none;position:absolute;top:56px;right:16px;z-index:999;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;width:320px;max-height:70vh;overflow-y:auto;box-shadow:var(--shadow);">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <div style="font-size:14px;font-weight:700;color:var(--text-bright);">ğŸ“Š Station Analytics</div>
    <button id="statsClose" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;">âœ•</button>
  </div>
  <div id="statsContent" style="font-size:12px;line-height:1.8;"></div>
</div>

<div class="app">
  <div class="sidebar" id="sidebar" role="complementary" aria-label="Station filters and list">
    <div class="drawer-handle" id="drawerHandle"><div class="drawer-handle-bar"></div></div>
    <div class="search-container">
      <div class="search-mode-tabs" style="display:flex;gap:0;margin-bottom:8px;">
        <button class="search-tab active" id="searchTabLocation" style="flex:1;padding:6px 8px;font-size:11px;font-weight:600;background:var(--accent);color:white;border:1px solid var(--accent);border-radius:var(--radius) 0 0 var(--radius);cursor:pointer;">ğŸ“ Location</button>
        <button class="search-tab" id="searchTabRoute" style="flex:1;padding:6px 8px;font-size:11px;font-weight:600;background:var(--bg-card);color:var(--text-dim);border:1px solid var(--border);border-radius:0 var(--radius) var(--radius) 0;cursor:pointer;">ğŸ›£ï¸ Route Corridor</button>
      </div>
      <div id="locationSearchPanel">
        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="Search by city, state, or ZIP..." aria-label="Search stations by location" autocomplete="off" />
          <button class="btn-icon" id="searchBtn" title="Search">ğŸ”</button>
          <button class="btn-icon" id="locateBtn" title="My Location">ğŸ“</button>
        </div>
      </div>
      <div id="routeSearchPanel" style="display:none;">
        <div class="search-box" style="margin-bottom:6px;">
          <input type="text" class="search-input" id="routeOrigin" placeholder="Origin (city, address, or ZIP)" aria-label="Route origin" autocomplete="off" />
        </div>
        <div class="search-box" style="margin-bottom:6px;">
          <input type="text" class="search-input" id="routeDestination" placeholder="Destination (city, address, or ZIP)" aria-label="Route destination" autocomplete="off" />
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px;">
          <label style="font-size:11px;color:var(--text-dim);">Radius:</label>
          <select id="routeRadius" style="flex:1;padding:4px 8px;font-size:11px;background:var(--bg-card);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);">
            <option value="2">2 miles</option>
            <option value="5" selected>5 miles</option>
            <option value="10">10 miles</option>
            <option value="25">25 miles</option>
          </select>
          <button class="btn btn-primary" id="routeSearchBtn" style="padding:6px 14px;font-size:12px;">Search Route</button>
        </div>
        <div id="routeStatus" style="font-size:11px;color:var(--text-dim);display:none;"></div>
      </div>
    </div>

    <div class="filters" id="filtersPanel">
      <div class="filter-section">
        <div class="filter-label">Vehicle Class</div>
        <div class="filter-chips" id="vehicleClassChips">
          <div class="chip active" data-filter="vehicleClass" data-value="all">All Commercial</div>
          <div class="chip" data-filter="vehicleClass" data-value="HD">HD (Class 7-8)</div>
          <div class="chip" data-filter="vehicleClass" data-value="MD">MD (Class 3-6)</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Connector Type</div>
        <div class="filter-chips" id="connectorChips">
          <div class="chip active" data-filter="connector" data-value="all">All</div>
          <div class="chip" data-filter="connector" data-value="TESLA">NACS</div>
          <div class="chip" data-filter="connector" data-value="J1772COMBO">CCS</div>
          <div class="chip" data-filter="connector" data-value="CHADEMO">CHAdeMO</div>
          <div class="chip" data-filter="connector" data-value="J3271">MCS</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Minimum Power</div>
        <div class="power-range">
          <input type="range" id="powerSlider" min="50" max="1000" step="50" value="150">
          <span class="power-value" id="powerValue">150+ kW</span>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Network</div>
        <div class="filter-chips" id="networkChips">
          <div class="chip active" data-filter="network" data-value="all">All</div>
          <div class="chip" data-filter="network" data-value="Tesla">Tesla</div>
          <div class="chip" data-filter="network" data-value="Electrify America">EA</div>
          <div class="chip" data-filter="network" data-value="ChargePoint Network">ChargePoint</div>
          <div class="chip" data-filter="network" data-value="WATT_EV">WattEV</div>
          <div class="chip" data-filter="network" data-value="eVgo Network">EVgo</div>
          <div class="chip" data-filter="network" data-value="Blink Network">Blink</div>
          <div class="chip" data-filter="network" data-value="EVCS">EVCS</div>
          <div class="chip" data-filter="network" data-value="SHELL_RECHARGE">Shell</div>
          <div class="chip" data-filter="network" data-value="BP_PULSE">bp pulse</div>
          <div class="chip" data-filter="network" data-value="IONNA">IONNA</div>
          <div class="chip" data-filter="network" data-value="FORD_CHARGE">Ford</div>
          <div class="chip" data-filter="network" data-value="MERCEDES_BENZ">MB HPC</div>
          <div class="chip" data-filter="network" data-value="FLASH">FLASH</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Facility Type</div>
        <div class="filter-chips" id="facilityChips">
          <div class="chip active" data-filter="facility" data-value="all">All</div>
          <div class="chip" data-filter="facility" data-value="TRUCK_STOP">Truck Stop</div>
          <div class="chip" data-filter="facility" data-value="TRAVEL_CENTER">Travel Center</div>
          <div class="chip" data-filter="facility" data-value="REST_STOP">Rest Stop</div>
          <div class="chip" data-filter="facility" data-value="FLEET_GARAGE">Fleet Garage</div>
          <div class="chip" data-filter="facility" data-value="GAS_STATION">Gas Station</div>
          <div class="chip" data-filter="facility" data-value="STANDALONE_STATION">Standalone</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Quick State</div>
        <div class="filter-chips" id="stateChips" style="max-height:60px;overflow-y:auto;">
          <div class="chip active" data-filter="state" data-value="all">All US</div>
          <div class="chip" data-filter="state" data-value="CA">CA</div>
          <div class="chip" data-filter="state" data-value="TX">TX</div>
          <div class="chip" data-filter="state" data-value="FL">FL</div>
          <div class="chip" data-filter="state" data-value="NY">NY</div>
          <div class="chip" data-filter="state" data-value="IL">IL</div>
          <div class="chip" data-filter="state" data-value="GA">GA</div>
          <div class="chip" data-filter="state" data-value="OH">OH</div>
          <div class="chip" data-filter="state" data-value="PA">PA</div>
          <div class="chip" data-filter="state" data-value="WA">WA</div>
          <div class="chip" data-filter="state" data-value="AZ">AZ</div>
          <div class="chip" data-filter="state" data-value="CO">CO</div>
          <div class="chip" data-filter="state" data-value="NJ">NJ</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Status</div>
        <div class="filter-chips" id="statusChips">
          <div class="chip active" data-filter="status" data-value="E">Available</div>
          <div class="chip" data-filter="status" data-value="all">All (incl. Planned)</div>
          <div class="chip" data-filter="status" data-value="P">Planned Only</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Funding</div>
        <div class="filter-chips" id="fundingChips">
          <div class="chip active" data-filter="funding" data-value="all">All</div>
          <div class="chip" data-filter="funding" data-value="NEVI">NEVI</div>
          <div class="chip" data-filter="funding" data-value="CFI">CFI</div>
        </div>
      </div>

      <div style="margin-top:4px;">
        <button class="btn btn-secondary" id="favToggle" style="width:100%;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:6px;">
          <span style="color:var(--amber);">â˜…</span> <span id="favToggleLabel">Show Favorites (<span id="favCount">0</span>)</span>
        </button>
      </div>

      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary" id="resetFilters" style="flex:1">Reset Filters</button>
        <button class="btn btn-secondary" id="exportBtn" style="flex:1" title="Export filtered stations as CSV">ğŸ“¥ CSV</button>
        <button class="btn btn-secondary" id="exportGeoBtn" style="flex:1" title="Export filtered stations as GeoJSON">ğŸ“¥ GeoJSON</button>
        <button class="btn btn-secondary" id="shareBtn" title="Copy shareable link">ğŸ”—</button>
      </div>
    </div>

    <div class="sidebar-header">
      <span class="sidebar-header-title">Stations</span>
      <span class="sidebar-header-count" id="filteredCount">Loading...</span>
    </div>

    <div class="station-list" id="stationList"></div>

    <div style="padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim);flex-shrink:0;line-height:1.8;">
      Built by <a href="https://jonahberg.com" target="_blank" rel="noopener noreferrer" style="color:var(--text);text-decoration:none;font-weight:500;">Jonah Berg</a> â€¢
      Data: <a href="https://afdc.energy.gov" target="_blank" rel="noopener noreferrer" style="color:var(--accent);text-decoration:none;">AFDC/DOE</a> â€¢
      <a href="https://github.com/notjbg/ev-charger-map" target="_blank" rel="noopener noreferrer" style="color:var(--accent);text-decoration:none;">Open Source</a><br>
      Press <kbd style="background:var(--bg-card);padding:1px 4px;border-radius:3px;border:1px solid var(--border);font-size:10px;">/</kbd> to search â€¢
      <span id="lastUpdatedFooter"></span>
    </div>
  </div>

  <button class="sidebar-toggle" id="sidebarToggle">â—€</button>

  <div class="map-container" role="main" aria-label="Interactive map">
    <div id="map"></div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Loading commercial charging stations...</div>
      <div class="loading-progress" id="loadingProgress"></div>
      <div class="progress-bar-container" style="width:200px;height:4px;background:var(--border);border-radius:2px;margin-top:12px;overflow:hidden;">
        <div class="progress-bar-fill" id="progressBar" style="width:0%;height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s ease;"></div>
      </div>
      <div id="errorBanner" style="display:none;margin-top:16px;padding:16px;background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:var(--radius);text-align:center;max-width:360px;">
        <div style="font-size:14px;font-weight:600;color:var(--red);margin-bottom:8px;">Failed to load station data</div>
        <div id="errorMessage" style="font-size:12px;color:var(--text-dim);margin-bottom:12px;"></div>
        <button class="btn btn-primary" id="retryBtn">Retry Now</button>
      </div>
    </div>

    <div class="map-info">
      <div class="info-card">
        <div class="info-card-value" id="mapStations">â€”</div>
        <div class="info-card-label">Visible</div>
      </div>
      <div class="info-card">
        <div class="info-card-value" id="mapPorts">â€”</div>
        <div class="info-card-label">DC Ports</div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-title">Power Level</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> 1 MW+ (MCS)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div> 350+ kW</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div> 150â€“349 kW</div>
      <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div> 50â€“149 kW</div>
      <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div> Unknown</div>
      <div style="margin-top:8px">
        <div class="legend-title">Vehicle Class</div>
        <div class="legend-item"><div class="legend-dot" style="background:transparent;border:3px solid #f97316"></div> HD (Class 7-8)</div>
        <div class="legend-item"><div class="legend-dot" style="background:transparent;border:3px solid #f59e0b"></div> MD (Class 3-6)</div>
        <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;opacity:0.5;outline:2px dashed rgba(255,255,255,0.4);outline-offset:1px"></div> Planned</div>
      </div>
    </div>

    <button class="locate-btn" id="geolocateBtn">ğŸ“ Near Me</button>

    <div class="welcome-card" id="welcomeCard">
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <div style="font-size:15px;font-weight:700;color:var(--text-bright);margin-bottom:8px;">âš¡ Commercial EV Charging Infrastructure</div>
        <button id="welcomeClose" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;" aria-label="Close welcome card">âœ•</button>
      </div>
      <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">
        This map shows <strong style="color:var(--text);">public DC fast charging stations</strong> relevant to
        medium and heavy-duty electric vehicles across the US. Data includes MD/HD tagged stations,
        truck stops, NEVI/CFI funded corridor chargers, and all 350kW+ stations.
        <br><br>
        <strong style="color:var(--amber);">Use filters</strong> to narrow by vehicle class, connector type, power level, or network.
        <strong style="color:var(--green);">Export CSV</strong> for fleet planning.
      </div>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detailPanel">
      <div class="detail-panel-header">
        <span style="font-size:13px;font-weight:600;color:var(--text-dim);">Station Details</span>
        <button class="detail-panel-close" id="detailPanelClose">âœ•</button>
      </div>
      <div class="detail-panel-body" id="detailPanelBody"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
(function() {
  'use strict';

  // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const API_BASE = 'https://developer.nrel.gov/api/alt-fuel-stations/v1';
  const API_KEY = '20VgRj1wFFvldXWK4gQ83YvctI1dntRFsqvJgbfc';
  const CACHE_KEY = 'chargefleet_cache';
  const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours
  const US_CENTER = [39.8283, -98.5795];
  const US_ZOOM = 5;

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let allStations = [];
  let filteredStations = [];
  let map, markerCluster, heatLayer, userMarker;
  let selectedStationId = null;
  let markerMap = {};
  let viewMode = 'markers'; // 'markers' | 'heat'
  let favorites = [];
  try { favorites = JSON.parse(localStorage.getItem('chargefleet_favs') || '[]'); } catch(e) { /* corrupt */ }

  const filters = {
    vehicleClass: 'all',
    connector: 'all',
    minPower: 150,
    network: 'all',
    facility: 'all',
    funding: 'all',
    status: 'E',
    state: 'all',
    search: '',
    favoritesOnly: false
  };

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function init() {
    initMap();
    initEventListeners();
    loadStateFromHash();
    loadData();
  }

  function initMap() {
    map = L.map('map', {
      center: US_CENTER,
      zoom: US_ZOOM,
      zoomControl: true,
      attributionControl: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap | Data: AFDC/DOE',
      maxZoom: 18
    }).addTo(map);

    markerCluster = L.markerClusterGroup({
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      disableClusteringAtZoom: 14,
      chunkedLoading: true,
      chunkInterval: 100,
      chunkDelay: 10
    });

    map.addLayer(markerCluster);
  }

  // â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadData() {
    const loadingEl = document.getElementById('loadingOverlay');
    const progressEl = document.getElementById('loadingProgress');

    // Try localStorage cache first
    try {
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const { data, ts } = JSON.parse(cached);
        if (Date.now() - ts < CACHE_TTL && data.length > 0) {
          // console.log(`Using cached data: ${data.length} stations (${((Date.now() - ts)/60000).toFixed(0)}m old)`);
          progressEl.textContent = `Loading ${data.length} cached stations...`;
          allStations = data;
          updateHeaderStats();
          applyFilters();
          loadingEl.classList.add('hidden');
          // Refresh in background
          setTimeout(() => refreshDataSilently(), 2000);
          return;
        }
      }
    } catch(e) { /* cache miss or corrupt */ }

    try {
      // Fetch available + planned in parallel batches
      const statusFilter = 'E,P'; // Both available and planned

      const progressBar = document.getElementById('progressBar');

      // Query 1: All stations tagged MD or HD vehicle class
      progressEl.textContent = 'Fetching MD/HD tagged stations...';
      progressBar.style.width = '10%';
      const mdhdData = await fetchStations({
        maximum_vehicle_class: 'MD',
        ev_charging_level: 'dc_fast',
        status: statusFilter,
        access: 'public',
        country: 'US'
      });

      // Query 2: High-power stations at truck-friendly facilities
      await delay(300);
      progressBar.style.width = '30%';
      progressEl.textContent = 'Fetching truck stop & travel center stations...';
      const truckData = await fetchStations({
        ev_charging_level: 'dc_fast',
        facility_type: 'TRUCK_STOP,TRAVEL_CENTER,REST_STOP,FLEET_GARAGE',
        status: statusFilter,
        access: 'public',
        country: 'US'
      });

      // Query 3: NEVI-funded stations (these are the federal highway corridor chargers)
      await delay(300);
      progressBar.style.width = '55%';
      progressEl.textContent = 'Fetching NEVI/CFI funded stations...';
      const neviData = await fetchStations({
        ev_charging_level: 'dc_fast',
        funding_sources: 'NEVI,CFI',
        status: statusFilter,
        access: 'public',
        country: 'US'
      });

      // Query 4: Very high power stations (350kW+) anywhere â€” these can serve commercial
      await delay(300);
      progressBar.style.width = '75%';
      progressEl.textContent = 'Fetching 350kW+ stations...';
      const highPowerData = await fetchStations({
        ev_charging_level: 'dc_fast',
        ev_power_kw_min: 350,
        status: statusFilter,
        access: 'public',
        country: 'US'
      });

      progressBar.style.width = '90%';
      progressEl.textContent = 'Processing station data...';

      // Merge and deduplicate by station ID
      const stationMap = new Map();

      const processStations = (stations, source) => {
        for (const s of stations) {
          if (!stationMap.has(s.id)) {
            s._sources = [source];
            s._maxPower = getMaxPower(s);
            stationMap.set(s.id, s);
          } else {
            stationMap.get(s.id)._sources.push(source);
          }
        }
      };

      processStations(mdhdData, 'mdhd');
      processStations(truckData, 'truck');
      processStations(neviData, 'nevi');
      processStations(highPowerData, 'highpower');

      allStations = Array.from(stationMap.values());
      // console.log(`Loaded ${allStations.length} unique stations`);

      // Cache to localStorage
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ data: allStations, ts: Date.now() }));
      } catch(e) { console.warn('Cache write failed:', e); }

      updateHeaderStats();
      applyFilters();
      loadingEl.classList.add('hidden');
      const ts = new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
      const luEl = document.getElementById('lastUpdated');
      if (luEl) luEl.textContent = ts;
      const luFooter = document.getElementById('lastUpdatedFooter');
      if (luFooter) luFooter.textContent = 'Updated ' + ts;

    } catch (err) {
      console.error('Failed to load data:', err);
      // Fall back to stale cache if available
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
          const { data, ts } = JSON.parse(cached);
          if (data && data.length > 0) {
            console.log(`Using stale cache: ${data.length} stations from ${new Date(ts).toLocaleString()}`);
            allStations = data;
            updateHeaderStats();
            applyFilters();
            loadingEl.classList.add('hidden');
            const age = Math.round((Date.now() - ts) / 3600000);
            const luEl = document.getElementById('lastUpdated');
            if (luEl) luEl.textContent = `Cached (${age}h ago)`;
            return;
          }
        }
      } catch(e) { /* no usable cache */ }
      document.querySelector('.spinner').style.display = 'none';
      document.querySelector('.loading-text').style.display = 'none';
      const errorBanner = document.getElementById('errorBanner');
      const errorMsg = document.getElementById('errorMessage');
      errorBanner.style.display = 'block';
      errorMsg.textContent = navigator.onLine
        ? `Error: ${err.message}. Cached data may be available after retry.`
        : 'You appear to be offline. Connect to the internet and retry.';
    }
  }

  async function fetchStations(params, retries = 3) {
    const queryParams = new URLSearchParams({
      api_key: API_KEY,
      fuel_type: 'ELEC',
      limit: 'all',
      ...params
    });

    const url = `${API_BASE}.json?${queryParams}`;

    for (let i = 0; i < retries; i++) {
      const resp = await fetch(url);
      if (resp.status === 429) {
        const wait = Math.pow(2, i + 1) * 1000 + Math.random() * 1000;
        console.warn(`Rate limited, retrying in ${Math.round(wait)}ms...`);
        await new Promise(r => setTimeout(r, wait));
        continue;
      }
      if (!resp.ok) throw new Error(`API error: ${resp.status}`);
      const data = await resp.json();
      return data.fuel_stations || [];
    }
    throw new Error('Rate limited after retries');
  }

  function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function refreshDataSilently() {
    try {
      const oldCount = allStations.length;
      // Re-run loadData logic silently
      const statusFilter = 'E,P';
      const stationMap = new Map();
      const processStations = (stations, source) => {
        for (const s of stations) {
          if (!stationMap.has(s.id)) {
            s._sources = [source];
            s._maxPower = getMaxPower(s);
            stationMap.set(s.id, s);
          } else {
            stationMap.get(s.id)._sources.push(source);
          }
        }
      };

      const [mdhdData, truckData, neviData, highPowerData] = await Promise.all([
        fetchStations({ maximum_vehicle_class: 'MD', ev_charging_level: 'dc_fast', status: statusFilter, access: 'public', country: 'US' }),
        fetchStations({ ev_charging_level: 'dc_fast', facility_type: 'TRUCK_STOP,TRAVEL_CENTER,REST_STOP,FLEET_GARAGE', status: statusFilter, access: 'public', country: 'US' }),
        fetchStations({ ev_charging_level: 'dc_fast', funding_sources: 'NEVI,CFI', status: statusFilter, access: 'public', country: 'US' }),
        fetchStations({ ev_charging_level: 'dc_fast', ev_power_kw_min: 350, status: statusFilter, access: 'public', country: 'US' })
      ]);

      processStations(mdhdData, 'mdhd');
      processStations(truckData, 'truck');
      processStations(neviData, 'nevi');
      processStations(highPowerData, 'highpower');

      const newStations = Array.from(stationMap.values());
      if (newStations.length > 0) {
        allStations = newStations;
        try { localStorage.setItem(CACHE_KEY, JSON.stringify({ data: allStations, ts: Date.now() })); } catch(e) {}
        updateHeaderStats();
        applyFilters();
        if (newStations.length !== oldCount) {
          // console.log(`Background refresh: ${oldCount} â†’ ${newStations.length} stations`);
        }
      }
    } catch(e) {
      // console.log('Background refresh failed (rate limited?) â€” using cached data');
    }
  }

  function getMaxPower(station) {
    let maxPower = 0;
    if (station.ev_charging_units) {
      for (const unit of station.ev_charging_units) {
        if (unit.connectors) {
          for (const [type, info] of Object.entries(unit.connectors)) {
            if (info.power_kw && info.power_kw > maxPower) {
              maxPower = info.power_kw;
            }
          }
        }
      }
    }
    return maxPower;
  }

  // â”€â”€ Filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    filteredStations = allStations.filter(s => {
      // Status
      if (filters.status !== 'all') {
        if (s.status_code !== filters.status) return false;
      }

      // State
      if (filters.state !== 'all') {
        if (s.state !== filters.state) return false;
      }

      // Vehicle class
      if (filters.vehicleClass !== 'all') {
        if (filters.vehicleClass === 'HD' && s.maximum_vehicle_class !== 'HD') return false;
        if (filters.vehicleClass === 'MD' && s.maximum_vehicle_class !== 'MD' && s.maximum_vehicle_class !== 'HD') return false;
      }

      // Connector
      if (filters.connector !== 'all') {
        if (!s.ev_connector_types || !s.ev_connector_types.includes(filters.connector)) return false;
      }

      // Min power
      if (filters.minPower > 0 && s._maxPower > 0 && s._maxPower < filters.minPower) return false;

      // Network
      if (filters.network !== 'all') {
        if (s.ev_network !== filters.network) return false;
      }

      // Facility
      if (filters.facility !== 'all') {
        if (s.facility_type !== filters.facility) return false;
      }

      // Funding
      if (filters.funding !== 'all') {
        if (!s.funding_sources || !s.funding_sources.includes(filters.funding)) return false;
      }

      // Fleet mode: 150kW+ and truck-accessible only
      if (fleetMode) {
        const isTruck = s.facility_type === 'TRUCK_STOP' || s.facility_type === 'TRAVEL_CENTER' ||
                         s.maximum_vehicle_class === 'HD' || s.maximum_vehicle_class === 'MD' ||
                         s._maxPower >= 150;
        if (!isTruck) return false;
        if (s._maxPower > 0 && s._maxPower < 150) return false;
      }

      // Favorites
      if (filters.favoritesOnly && !favorites.includes(String(s.id))) return false;

      // Search
      if (filters.search) {
        const q = filters.search.toLowerCase();
        const searchFields = [
          s.station_name, s.city, s.state, s.zip,
          s.street_address, s.ev_network
        ].filter(Boolean).join(' ').toLowerCase();
        if (!searchFields.includes(q)) return false;
      }

      return true;
    });

    updateMarkers();
    updateStationList();
    updateMapInfo();
    scheduleHashUpdate();
  }

  // â”€â”€ Markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateMarkers() {
    markerCluster.clearLayers();
    if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
    markerMap = {};

    if (viewMode === 'heat') {
      const heatPoints = filteredStations.filter(s => s.latitude && s.longitude).map(s => {
        const intensity = s._maxPower > 0 ? Math.min(s._maxPower / 500, 1) : 0.3;
        return [s.latitude, s.longitude, intensity];
      });
      heatLayer = L.heatLayer(heatPoints, {
        radius: 25, blur: 15, maxZoom: 10,
        gradient: { 0.2: '#3b82f6', 0.4: '#06b6d4', 0.6: '#f59e0b', 0.8: '#f97316', 1.0: '#ef4444' }
      }).addTo(map);
      return;
    }

    const markers = filteredStations.filter(s => s.latitude && s.longitude).map(s => {
      const color = getPowerColor(s._maxPower);
      const size = getMarkerSize(s);
      const borderColor = getVehicleClassBorder(s);

      const isPlanned = s.status_code === 'P';
      const opacity = isPlanned ? '0.5' : '1';
      const outline = isPlanned ? 'outline:2px dashed rgba(255,255,255,0.4);outline-offset:2px;' : '';
      const isNevi = s.funding_sources && s.funding_sources.includes('NEVI');
      const neviGlow = (fleetMode && isNevi) ? 'box-shadow:0 0 12px 4px rgba(16,185,129,0.6);' : '';
      const neviClass = isNevi ? ' nevi-station' : '';

      const icon = L.divIcon({
        className: 'custom-marker' + neviClass,
        html: `<div style="width:${size}px;height:${size}px;background:${color};border-radius:50%;border:${borderColor ? '3px solid ' + borderColor : '2px solid rgba(255,255,255,0.3)'};opacity:${opacity};${outline}${neviGlow}"></div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });

      const marker = L.marker([s.latitude, s.longitude], { icon });
      marker.on('click', () => { selectStation(s.id); openDetailPanel(s); });
      markerMap[s.id] = marker;
      return marker;
    });

    markerCluster.addLayers(markers);
  }

  function getPowerColor(power) {
    if (power >= 1000) return '#ef4444'; // MCS-class
    if (power >= 350) return '#f97316';  // Ultra-fast
    if (power >= 150) return '#f59e0b';  // Fast
    if (power > 0) return '#3b82f6';     // Standard DCFC
    return '#8b5cf6';                     // Unknown
  }

  function getVehicleClassBorder(station) {
    if (station.maximum_vehicle_class === 'HD') return '#f97316';
    if (station.maximum_vehicle_class === 'MD') return '#f59e0b';
    return null;
  }

  function getMarkerSize(station) {
    if (station._maxPower >= 1000) return 16;
    if (station._maxPower >= 350) return 14;
    if (station.maximum_vehicle_class === 'HD') return 14;
    return 12;
  }

  // â”€â”€ Fleet Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let fleetMode = false;

  // â”€â”€ Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openDetailPanel(s) {
    const panel = document.getElementById('detailPanel');
    const body = document.getElementById('detailPanelBody');

    const connectors = (s.ev_connector_types || []).map(c => {
      const labels = { 'TESLA': 'NACS', 'J1772COMBO': 'CCS', 'CHADEMO': 'CHAdeMO', 'J1772': 'J1772', 'J3271': 'MCS', 'NEMA1450': 'NEMA 14-50' };
      return labels[c] || c;
    });

    const powerClass = s._maxPower >= 350 ? 'power-ultra' : s._maxPower >= 150 ? 'power-fast' : 'power-standard';
    const connectorBadges = connectors.map(c =>
      `<span class="connector-badge ${powerClass}">${c}</span>`
    ).join('');

    const isTruckFriendly = s.facility_type === 'TRUCK_STOP' || s.facility_type === 'TRAVEL_CENTER' ||
                             s.maximum_vehicle_class === 'HD' || s.maximum_vehicle_class === 'MD';

    const isOpen = s.access_days_time && s.access_days_time.toLowerCase().includes('24');
    const hoursDotClass = s.access_days_time ? (isOpen ? 'open' : 'open') : 'unknown';
    const hoursLabel = isOpen ? 'Open 24/7' : (s.access_days_time || 'Hours unknown');

    const tags = [];
    if (s.status_code === 'P') tags.push('<span class="tag" style="background:rgba(139,92,246,0.15);color:#8b5cf6;">PLANNED</span>');
    if (s.maximum_vehicle_class === 'HD') tags.push('<span class="tag tag-hd">HD Class 7-8</span>');
    if (s.maximum_vehicle_class === 'MD') tags.push('<span class="tag tag-md">MD Class 3-6</span>');
    if (s._maxPower >= 1000) tags.push('<span class="tag tag-mcs">MW-Class</span>');
    if (s.funding_sources) {
      s.funding_sources.forEach(f => {
        if (f === 'NEVI') tags.push('<span class="tag tag-nevi">NEVI</span>');
        if (f === 'CFI') tags.push('<span class="tag tag-nevi">CFI</span>');
      });
    }

    const facilityLabels = {
      'TRUCK_STOP': 'Truck Stop', 'TRAVEL_CENTER': 'Travel Center', 'REST_STOP': 'Rest Stop',
      'FLEET_GARAGE': 'Fleet Garage', 'GAS_STATION': 'Gas Station', 'STANDALONE_STATION': 'Standalone'
    };

    let distanceHtml = '';
    if (userLocation) {
      const dist = haversineDistance(userLocation.lat, userLocation.lng, s.latitude, s.longitude);
      distanceHtml = `<div style="font-size:13px;color:var(--cyan);font-weight:600;margin-bottom:12px;">ğŸ“ ${dist.toFixed(1)} miles away</div>`;
    }

    const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}`;

    let fleetHtml = '';
    if (fleetMode && s._maxPower >= 150) {
      fleetHtml = `
        <div class="detail-fleet-section">
          <div class="detail-section-label" style="margin-top:0;">ğŸš› Fleet Charge Estimates (10â€“80%)</div>
          <div class="fleet-vehicle-row"><span class="fleet-vehicle-name">Tesla Semi</span><span class="fleet-vehicle-time">~60 min</span></div>
          <div class="fleet-vehicle-row"><span class="fleet-vehicle-name">Freightliner eCascadia</span><span class="fleet-vehicle-time">~45 min</span></div>
          <div class="fleet-vehicle-row"><span class="fleet-vehicle-name">Volvo VNR Electric</span><span class="fleet-vehicle-time">~40 min</span></div>
        </div>`;
    }

    body.innerHTML = `
      <div class="detail-station-name">${escHtml(s.station_name)}</div>
      <div class="detail-address">${escHtml(s.street_address)}, ${escHtml(s.city)}, ${s.state} ${s.zip}</div>
      <span class="detail-network-badge">${escHtml(networkDisplay(s.ev_network) || 'Unknown Network')}</span>
      <div class="detail-tags">${tags.join('')}</div>
      ${distanceHtml}
      ${isTruckFriendly ? '<div class="detail-truck-access">ğŸš› Truck Accessible</div>' : ''}
      <div class="detail-section-label">Connectors</div>
      <div class="detail-connectors">${connectorBadges || '<span style="color:var(--text-dim);font-size:13px;">Unknown</span>'}</div>
      <div class="detail-hours">
        <span class="hours-dot ${hoursDotClass}"></span>
        <span style="color:var(--text);">${escHtml(hoursLabel)}</span>
      </div>
      <div class="detail-grid">
        <div class="detail-grid-item">
          <div class="detail-grid-label">Max Power</div>
          <div class="detail-grid-value">${s._maxPower > 0 ? s._maxPower + ' kW' : 'â€”'}</div>
        </div>
        <div class="detail-grid-item">
          <div class="detail-grid-label">DC Fast Ports</div>
          <div class="detail-grid-value">${s.ev_dc_fast_num || 'â€”'}</div>
        </div>
        <div class="detail-grid-item">
          <div class="detail-grid-label">Facility</div>
          <div class="detail-grid-value">${facilityLabels[s.facility_type] || s.facility_type || 'â€”'}</div>
        </div>
        <div class="detail-grid-item">
          <div class="detail-grid-label">Status</div>
          <div class="detail-grid-value">${s.status_code === 'E' ? 'âœ… Available' : s.status_code === 'P' ? 'ğŸ”® Planned' : s.status_code}</div>
        </div>
      </div>
      ${s.ev_pricing ? `<div style="font-size:13px;color:var(--green);margin-bottom:8px;">ğŸ’° ${escHtml(s.ev_pricing)}</div>` : ''}
      ${s.station_phone ? `<div style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">ğŸ“ <a href="tel:${encodeURIComponent(s.station_phone.split(' ')[0])}" style="color:var(--accent);text-decoration:none;">${escHtml(s.station_phone.split(' ')[0])}</a></div>` : ''}
      ${fleetHtml}
      <div class="detail-actions">
        <a class="btn btn-primary" href="${directionsUrl}" target="_blank" rel="noopener noreferrer" style="text-decoration:none;color:white;">ğŸ“ Directions</a>
        <button class="btn btn-secondary fav-btn" data-fav="${s.id}">${favorites.includes(String(s.id)) ? 'â˜… Saved' : 'â˜† Save'}</button>
      </div>
    `;

    panel.classList.add('open');
  }

  function closeDetailPanel() {
    document.getElementById('detailPanel').classList.remove('open');
  }

  // â”€â”€ Popup (kept for fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function createPopupContent(s) {
    const connectors = (s.ev_connector_types || []).map(c => {
      const labels = {
        'TESLA': 'NACS', 'J1772COMBO': 'CCS', 'CHADEMO': 'CHAdeMO',
        'J1772': 'J1772', 'J3271': 'MCS', 'NEMA1450': 'NEMA 14-50'
      };
      return labels[c] || c;
    });

    const tags = [];
    if (s.status_code === 'P') tags.push('<span class="tag" style="background:rgba(139,92,246,0.15);color:#8b5cf6;">PLANNED</span>');
    if (s.maximum_vehicle_class === 'HD') tags.push('<span class="tag tag-hd">HD Class 7-8</span>');
    if (s.maximum_vehicle_class === 'MD') tags.push('<span class="tag tag-md">MD Class 3-6</span>');
    if (s._maxPower >= 1000) tags.push('<span class="tag tag-mcs">MW-Class</span>');
    if (s.funding_sources) {
      s.funding_sources.forEach(f => {
        if (f === 'NEVI') tags.push('<span class="tag tag-nevi">NEVI</span>');
        if (f === 'CFI') tags.push('<span class="tag tag-nevi">CFI</span>');
      });
    }
    if (s.facility_type === 'TRUCK_STOP') tags.push('<span class="tag tag-truck">Truck Stop</span>');
    if (s.facility_type === 'TRAVEL_CENTER') tags.push('<span class="tag tag-truck">Travel Center</span>');

    connectors.forEach(c => {
      tags.push(`<span class="tag tag-connector">${c}</span>`);
    });

    const facilityLabels = {
      'TRUCK_STOP': 'Truck Stop', 'TRAVEL_CENTER': 'Travel Center', 'REST_STOP': 'Rest Stop',
      'FLEET_GARAGE': 'Fleet Garage', 'GAS_STATION': 'Gas Station', 'STANDALONE_STATION': 'Standalone',
      'CONVENIENCE_STORE': 'Convenience Store', 'PARKING_LOT': 'Parking Lot', 'PARKING_GARAGE': 'Parking Garage',
      'SHOPPING_CENTER': 'Shopping Center', 'HOTEL': 'Hotel', 'RESTAURANT': 'Restaurant', 'OTHER': 'Other',
      'CAR_DEALER': 'Car Dealer', 'GROCERY': 'Grocery', 'RETAIL': 'Retail', 'OFFICE_BLDG': 'Office',
      'WORKPLACE': 'Workplace'
    };

    // Distance from user or map center
    let distanceHtml = '';
    if (userLocation) {
      const dist = haversineDistance(userLocation.lat, userLocation.lng, s.latitude, s.longitude);
      distanceHtml = `<div style="font-size:12px;color:var(--cyan);font-weight:600;margin-bottom:4px;">ğŸ“ ${dist.toFixed(1)} miles from you</div>`;
    } else {
      const center = map.getCenter();
      const dist = haversineDistance(center.lat, center.lng, s.latitude, s.longitude);
      if (dist < 500) {
        distanceHtml = `<div style="font-size:12px;color:var(--text-dim);margin-bottom:4px;">ğŸ“ ~${dist.toFixed(0)} mi from map center</div>`;
      }
    }

    const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}`;

    return `
      <div class="popup-title">${escHtml(s.station_name)}</div>
      <div class="popup-address">${escHtml(s.street_address)}, ${escHtml(s.city)}, ${s.state} ${s.zip}</div>
      <div class="popup-tags">${tags.join('')}</div>
      <div class="popup-grid">
        <div class="popup-item">
          <span class="popup-item-label">Network</span>
          <span class="popup-item-value">${escHtml(networkDisplay(s.ev_network) || 'Unknown')}</span>
        </div>
        <div class="popup-item">
          <span class="popup-item-label">Max Power</span>
          <span class="popup-item-value">${s._maxPower > 0 ? s._maxPower + ' kW' : 'Unknown'}</span>
        </div>
        <div class="popup-item">
          <span class="popup-item-label">DC Fast Ports</span>
          <span class="popup-item-value">${s.ev_dc_fast_num || 'â€”'}</span>
        </div>
        <div class="popup-item">
          <span class="popup-item-label">Facility</span>
          <span class="popup-item-value">${facilityLabels[s.facility_type] || s.facility_type || 'â€”'}</span>
        </div>
      </div>
      ${distanceHtml}
      ${s.ev_pricing ? `<div class="popup-pricing">ğŸ’° ${escHtml(s.ev_pricing)}</div>` : ''}
      ${s.expected_date && s.status_code === 'P' ? `<div class="popup-hours" style="color:var(--purple)">ğŸ“… Expected: ${escHtml(s.expected_date)}</div>` : ''}
      ${s.access_days_time ? `<div class="popup-hours">ğŸ• ${escHtml(s.access_days_time)}</div>` : ''}
      ${s.station_phone ? `<div style="font-size:12px;color:var(--text-dim);margin-top:4px;">ğŸ“ <a href="tel:${encodeURIComponent(s.station_phone.split(' ')[0])}" style="color:var(--accent);text-decoration:none;">${escHtml(s.station_phone.split(' ')[0])}</a></div>` : ''}
      ${s.date_last_confirmed ? `<div style="font-size:10px;color:var(--text-dim);margin-top:4px;">Last confirmed: ${escHtml(s.date_last_confirmed)}</div>` : ''}
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
        <a class="popup-directions" href="${directionsUrl}" target="_blank" rel="noopener noreferrer" style="flex:1;">ğŸ“ Get Directions â†’</a>
        <button class="fav-btn" data-fav="${s.id}" onclick="event.stopPropagation()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--amber);cursor:pointer;font-size:16px;padding:4px 10px;">${favorites.includes(String(s.id)) ? 'â˜… Saved' : 'â˜† Save'}</button>
      </div>
    `;
  }

  // â”€â”€ Station List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStationList() {
    const listEl = document.getElementById('stationList');
    const countEl = document.getElementById('filteredCount');

    const hdCount = filteredStations.filter(s => s.maximum_vehicle_class === 'HD').length;
    const mdCount = filteredStations.filter(s => s.maximum_vehicle_class === 'MD').length;
    const plannedCount = filteredStations.filter(s => s.status_code === 'P').length;
    const neviCount = filteredStations.filter(s => s.funding_sources?.includes('NEVI')).length;
    const mcsCount = filteredStations.filter(s => s.ev_connector_types?.includes('J3271')).length;

    countEl.textContent = `${filteredStations.length} of ${allStations.length}`;

    if (filteredStations.length === 0) {
      listEl.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ”Œ</div>
          <div class="empty-state-title">No stations match</div>
          <div class="empty-state-text">Try adjusting your filters or search area.</div>
        </div>
      `;
      return;
    }

    // Summary bar
    let summaryHtml = '<div style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border-bottom:1px solid var(--border);margin-bottom:4px;">';
    if (hdCount > 0) summaryHtml += `<span class="tag tag-hd">${hdCount} HD</span>`;
    if (mdCount > 0) summaryHtml += `<span class="tag tag-md">${mdCount} MD</span>`;
    if (neviCount > 0) summaryHtml += `<span class="tag tag-nevi">${neviCount} NEVI</span>`;
    if (mcsCount > 0) summaryHtml += `<span class="tag tag-mcs">${mcsCount} MCS</span>`;
    if (plannedCount > 0) summaryHtml += `<span class="tag" style="background:rgba(139,92,246,0.15);color:#8b5cf6;">${plannedCount} Planned</span>`;
    summaryHtml += '</div>';

    // Sort by distance from map center if zoomed in, otherwise by state then name
    const center = map.getCenter();
    const sorted = [...filteredStations];

    if (map.getZoom() > 7) {
      sorted.sort((a, b) => {
        const distA = Math.pow(a.latitude - center.lat, 2) + Math.pow(a.longitude - center.lng, 2);
        const distB = Math.pow(b.latitude - center.lat, 2) + Math.pow(b.longitude - center.lng, 2);
        return distA - distB;
      });
    } else {
      sorted.sort((a, b) => {
        if (a.state !== b.state) return (a.state || '').localeCompare(b.state || '');
        return (a.station_name || '').localeCompare(b.station_name || '');
      });
    }

    // Virtual scrolling: render only first 100
    const visible = sorted.slice(0, 100);

    listEl.innerHTML = summaryHtml + visible.map(s => {
      const tags = [];
      if (s.maximum_vehicle_class === 'HD') tags.push('<span class="tag tag-hd">HD</span>');
      else if (s.maximum_vehicle_class === 'MD') tags.push('<span class="tag tag-md">MD</span>');
      if (s._maxPower > 0) tags.push(`<span class="tag tag-power">${s._maxPower >= 1000 ? (s._maxPower/1000).toFixed(1)+'MW' : s._maxPower+'kW'}</span>`);
      if (s.ev_network) tags.push(`<span class="tag tag-network">${escHtml(networkShort(s.ev_network))}</span>`);
      if (s.funding_sources?.includes('NEVI')) tags.push('<span class="tag tag-nevi">NEVI</span>');
      if (s.facility_type === 'TRUCK_STOP' || s.facility_type === 'TRAVEL_CENTER') tags.push('<span class="tag tag-truck">ğŸš›</span>');

      let distText = '';
      if (userLocation) {
        const dist = haversineDistance(userLocation.lat, userLocation.lng, s.latitude, s.longitude);
        distText = `<span style="font-size:11px;color:var(--cyan);margin-left:auto;white-space:nowrap;">${dist.toFixed(0)} mi</span>`;
      }

      const selected = s.id === selectedStationId ? ' selected' : '';

      return `
        <div class="station-card${selected}" data-id="${s.id}">
          <div class="station-name" style="display:flex;align-items:center;">
            <span style="color:${getPowerColor(s._maxPower)};font-size:10px;">â—</span>
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${escHtml(s.station_name || 'Unknown Station')}</span>
            ${distText}
            <button class="fav-btn" data-fav="${s.id}" onclick="event.stopPropagation()" style="background:none;border:none;color:var(--amber);cursor:pointer;font-size:14px;padding:0 2px;flex-shrink:0;">${favorites.includes(String(s.id)) ? 'â˜…' : 'â˜†'}</button>
          </div>
          <div class="station-address">${escHtml(s.city || '')}, ${s.state || ''} ${s.zip || ''}</div>
          <div class="station-tags">${tags.join('')}</div>
        </div>
      `;
    }).join('');

    if (sorted.length > 100) {
      listEl.innerHTML += `<div style="padding:12px;text-align:center;color:var(--text-dim);font-size:12px;">Showing 100 of ${sorted.length} â€” zoom in or search to narrow</div>`;
    }

    // Card click handlers
    listEl.querySelectorAll('.station-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = parseInt(card.dataset.id);
        selectStation(id);
        const station = allStations.find(s => s.id === id);
        if (station) {
          map.setView([station.latitude, station.longitude], 14);
          openDetailPanel(station);
        }
      });
    });
  }

  const NETWORK_NAMES = {
    'Electrify America': 'Electrify America',
    'ChargePoint Network': 'ChargePoint',
    'eVgo Network': 'EVgo',
    'Blink Network': 'Blink',
    'Non-Networked': 'Non-Networked',
    'Tesla': 'Tesla Supercharger',
    'Tesla Destination': 'Tesla Destination',
    'SHELL_RECHARGE': 'Shell Recharge',
    'BP_PULSE': 'bp pulse',
    'WATT_EV': 'WattEV',
    'EVCS': 'EVCS',
    'EV Connect': 'EV Connect',
    'EVGATEWAY': 'EvGateway',
    'ELECTRIC_ERA': 'Electric Era',
    'IONNA': 'IONNA',
    'FORD_CHARGE': 'Ford Charge',
    'MERCEDES_BENZ': 'Mercedes-Benz HPC',
    'FLASH': 'FLASH',
    'GRAVITY_CHARGING_CENTER': 'Gravity',
    'POWERFLEX': 'PowerFlex',
    'POWERCHARGE': 'PowerCharge',
    'FLO': 'FLO',
    'CIRCLE_K': 'Circle K',
    'RIVIAN_ADVENTURE': 'Rivian Adventure',
    'WALMART': 'Walmart'
  };

  function networkDisplay(network) {
    return NETWORK_NAMES[network] || network;
  }

  function networkShort(network) {
    const shorts = {
      'Electrify America': 'EA',
      'ChargePoint Network': 'ChargePoint',
      'eVgo Network': 'EVgo',
      'Blink Network': 'Blink',
      'Non-Networked': 'Non-Net',
      'Tesla': 'Tesla SC',
      'Tesla Destination': 'Tesla Dest',
      'SHELL_RECHARGE': 'Shell',
      'BP_PULSE': 'bp pulse',
      'WATT_EV': 'WattEV'
    };
    return shorts[network] || NETWORK_NAMES[network] || network;
  }

  function selectStation(id) {
    selectedStationId = id;
    document.querySelectorAll('.station-card').forEach(c => {
      c.classList.toggle('selected', parseInt(c.dataset.id) === id);
    });
  }

  // â”€â”€ UI Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateHeaderStats() {
    document.getElementById('totalStations').textContent = allStations.length.toLocaleString();

    let totalPorts = 0;
    const networks = new Set();
    allStations.forEach(s => {
      totalPorts += (s.ev_dc_fast_num || 0);
      if (s.ev_network) networks.add(s.ev_network);
    });

    document.getElementById('totalPorts').textContent = totalPorts.toLocaleString();
    document.getElementById('totalNetworks').textContent = networks.size;

    // Fetch last updated date
    fetch(`${API_BASE}/last-updated.json?api_key=${API_KEY}`)
      .then(r => r.json())
      .then(d => {
        if (d.last_updated) {
          const date = new Date(d.last_updated);
          document.getElementById('lastUpdated').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
      })
      .catch(() => {});
  }

  function updateMapInfo() {
    document.getElementById('mapStations').textContent = filteredStations.length.toLocaleString();
    let ports = 0;
    filteredStations.forEach(s => ports += (s.ev_dc_fast_num || 0));
    document.getElementById('mapPorts').textContent = ports.toLocaleString();
  }

  // â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initEventListeners() {
    // Filter chips
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const filterType = chip.dataset.filter;
        const value = chip.dataset.value;

        // Deactivate siblings, activate this one
        chip.closest('.filter-chips').querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');

        filters[filterType] = value;
        applyFilters();

        // Auto-zoom to state
        if (filterType === 'state' && value !== 'all') {
          const stateCenters = {
            CA:[36.78,-119.42], TX:[31.97,-99.90], FL:[27.66,-81.52], NY:[42.17,-74.95],
            IL:[40.63,-89.40], GA:[32.16,-82.90], OH:[40.42,-82.91], PA:[41.20,-77.19],
            WA:[47.75,-120.74], AZ:[34.05,-111.09], CO:[39.55,-105.78], NJ:[40.06,-74.41]
          };
          if (stateCenters[value]) map.setView(stateCenters[value], 7);
        } else if (filterType === 'state' && value === 'all') {
          map.setView(US_CENTER, US_ZOOM);
        }
      });
    });

    // Power slider
    const powerSlider = document.getElementById('powerSlider');
    const powerValue = document.getElementById('powerValue');
    powerSlider.addEventListener('input', () => {
      const val = parseInt(powerSlider.value);
      filters.minPower = val;
      powerValue.textContent = val >= 1000 ? `${(val/1000).toFixed(1)}+ MW` : `${val}+ kW`;
      applyFilters();
    });

    // Search
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        filters.search = searchInput.value.trim();
        applyFilters();
      }, 300);
    });

    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        filters.search = searchInput.value.trim();
        applyFilters();
        geocodeSearch(searchInput.value.trim());
      }
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      filters.search = searchInput.value.trim();
      applyFilters();
      geocodeSearch(searchInput.value.trim());
    });

    // Geolocation
    document.getElementById('locateBtn').addEventListener('click', geolocate);
    document.getElementById('geolocateBtn').addEventListener('click', geolocate);

    // Sidebar toggle
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('sidebarToggle');
      sidebar.classList.toggle('collapsed');
      btn.textContent = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
      setTimeout(() => map.invalidateSize(), 350);
    });

    // Reset filters
    document.getElementById('resetFilters').addEventListener('click', () => {
      filters.vehicleClass = 'all';
      filters.connector = 'all';
      filters.minPower = 150;
      filters.network = 'all';
      filters.facility = 'all';
      filters.funding = 'all';
      filters.status = 'E';
      filters.state = 'all';
      filters.search = '';
      filters.favoritesOnly = false;

      document.querySelectorAll('.chip').forEach(c => {
        // Status defaults to 'E', everything else to 'all'
        const isDefault = c.dataset.filter === 'status' ? c.dataset.value === 'E' : c.dataset.value === 'all';
        c.classList.toggle('active', isDefault);
      });
      // Reset favorites toggle UI
      const favBtn = document.getElementById('favToggle');
      favBtn.style.background = '';
      favBtn.style.borderColor = '';
      document.getElementById('favToggleLabel').innerHTML = `Show Favorites (<span id="favCount">${favorites.length}</span>)`;
      powerSlider.value = 150;
      powerValue.textContent = '150+ kW';
      searchInput.value = '';

      applyFilters();
      map.setView(US_CENTER, US_ZOOM);
    });

    // Export CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      if (filteredStations.length === 0) {
        showToast('No stations to export.');
        return;
      }
      const headers = ['Name','Address','City','State','ZIP','Latitude','Longitude','Network','Max Power (kW)','DC Fast Ports','Connectors','Vehicle Class','Facility Type','Hours','Pricing','Funding'];
      const rows = filteredStations.map(s => [
        s.station_name, s.street_address, s.city, s.state, s.zip,
        s.latitude, s.longitude, s.ev_network, s._maxPower || '',
        s.ev_dc_fast_num || '', (s.ev_connector_types || []).join('; '),
        s.maximum_vehicle_class || '', s.facility_type || '',
        s.access_days_time || '', s.ev_pricing || '',
        (s.funding_sources || []).join('; ')
      ]);
      const csv = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chargefleet-stations-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast(`Exported ${filteredStations.length} stations.`);
    });

    // GeoJSON Export
    document.getElementById('exportGeoBtn').addEventListener('click', exportGeoJSON);

    // Stats Dashboard
    document.getElementById('statsToggle').addEventListener('click', () => {
      const dash = document.getElementById('statsDashboard');
      if (dash.style.display === 'none') {
        updateStats();
        dash.style.display = 'block';
      } else {
        dash.style.display = 'none';
      }
    });
    document.getElementById('statsClose').addEventListener('click', () => {
      document.getElementById('statsDashboard').style.display = 'none';
    });

    // Route Search
    initRouteSearch();

    // Share link
    document.getElementById('shareBtn').addEventListener('click', () => {
      saveStateToHash();
      navigator.clipboard.writeText(window.location.href).then(() => {
        showToast('Link copied to clipboard!');
      }).catch(() => {
        showToast('Copy this URL to share: ' + window.location.href);
      });
    });

    // View mode toggle
    document.getElementById('viewMarkers').addEventListener('click', () => {
      viewMode = 'markers';
      document.getElementById('viewMarkers').style.background = 'var(--accent)';
      document.getElementById('viewMarkers').style.color = 'white';
      document.getElementById('viewHeat').style.background = 'var(--bg-card)';
      document.getElementById('viewHeat').style.color = 'var(--text)';
      updateMarkers();
    });

    document.getElementById('viewHeat').addEventListener('click', () => {
      viewMode = 'heat';
      document.getElementById('viewHeat').style.background = 'var(--accent)';
      document.getElementById('viewHeat').style.color = 'white';
      document.getElementById('viewMarkers').style.background = 'var(--bg-card)';
      document.getElementById('viewMarkers').style.color = 'var(--text)';
      updateMarkers();
    });

    // Fleet mode
    document.getElementById('fleetModeBtn').addEventListener('click', () => {
      fleetMode = !fleetMode;
      const btn = document.getElementById('fleetModeBtn');
      btn.style.background = fleetMode ? 'var(--orange)' : 'var(--bg-card)';
      btn.style.color = fleetMode ? 'white' : 'var(--text)';
      // Add/remove fleet mode badge
      let badge = document.getElementById('fleetModeBadge');
      if (fleetMode) {
        if (!badge) {
          badge = document.createElement('span');
          badge.id = 'fleetModeBadge';
          badge.className = 'fleet-mode-badge';
          badge.textContent = 'ğŸš› Fleet Mode';
          document.querySelector('.header-left').appendChild(badge);
        }
        // Auto-set filters for fleet: 150kW+, show truck-friendly
        filters.minPower = 150;
        document.getElementById('powerSlider').value = 150;
        document.getElementById('powerValue').textContent = '150+ kW';
        document.body.classList.add('fleet-mode-active');
      } else {
        if (badge) badge.remove();
        document.body.classList.remove('fleet-mode-active');
      }
      applyFilters();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
      if (e.key === 'Escape') {
        document.getElementById('searchInput').blur();
      }
    });

    // Detail panel close
    document.getElementById('detailPanelClose').addEventListener('click', closeDetailPanel);
    map.on('click', (e) => {
      if (document.getElementById('detailPanel').classList.contains('open')) {
        closeDetailPanel();
      }
    });

    // Welcome close
    document.getElementById('welcomeClose').addEventListener('click', () => {
      document.getElementById('welcomeCard').style.display = 'none';
    });

    // Retry button
    document.getElementById('retryBtn').addEventListener('click', () => {
      document.getElementById('errorBanner').style.display = 'none';
      document.querySelector('.spinner').style.display = 'block';
      document.querySelector('.loading-text').style.display = 'block';
      loadData();
    });

    // Favorites toggle
    document.getElementById('favToggle').addEventListener('click', () => {
      filters.favoritesOnly = !filters.favoritesOnly;
      const btn = document.getElementById('favToggle');
      btn.style.background = filters.favoritesOnly ? 'rgba(245,158,11,0.15)' : '';
      btn.style.borderColor = filters.favoritesOnly ? 'var(--amber)' : '';
      document.getElementById('favToggleLabel').innerHTML = filters.favoritesOnly
        ? 'Showing Favorites Only'
        : `Show Favorites (<span id="favCount">${favorites.length}</span>)`;
      applyFilters();
    });
    document.getElementById('favCount').textContent = favorites.length;

    // Favorites delegation
    document.addEventListener('click', e => {
      const btn = e.target.closest('.fav-btn');
      if (btn) { toggleFavorite(btn.dataset.fav); e.stopPropagation(); }
    });

    // Mobile drawer swipe
    if (window.innerWidth <= 768) {
      const handle = document.getElementById('drawerHandle');
      const sidebar = document.getElementById('sidebar');
      let startY, startH;
      handle.addEventListener('touchstart', e => {
        startY = e.touches[0].clientY;
        startH = sidebar.offsetHeight;
        sidebar.style.transition = 'none';
      });
      handle.addEventListener('touchmove', e => {
        const dy = startY - e.touches[0].clientY;
        const newH = Math.max(60, Math.min(window.innerHeight * 0.85, startH + dy));
        sidebar.style.height = newH + 'px';
        e.preventDefault();
      }, { passive: false });
      handle.addEventListener('touchend', () => {
        sidebar.style.transition = 'height 0.3s ease';
        const h = sidebar.offsetHeight, vh = window.innerHeight;
        if (h < vh * 0.15) { sidebar.classList.add('collapsed'); sidebar.style.height = ''; }
        else if (h < vh * 0.5) { sidebar.style.height = '30vh'; sidebar.classList.remove('collapsed'); }
        else { sidebar.style.height = '70vh'; sidebar.classList.remove('collapsed'); }
        setTimeout(() => map.invalidateSize(), 350);
      });
    }

    // Update list when map moves
    map.on('moveend', () => {
      if (map.getZoom() > 7) updateStationList();
      scheduleHashUpdate();
    });
  }

  // â”€â”€ Geocoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function geocodeSearch(query) {
    if (!query) return;
    try {
      const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`);
      const results = await resp.json();
      if (results.length > 0) {
        const { lat, lon } = results[0];
        map.setView([parseFloat(lat), parseFloat(lon)], 10);
      }
    } catch (err) {
      console.error('Geocode error:', err);
    }
  }

  function geolocate() {
    if (!navigator.geolocation) {
      showToast('Geolocation not supported by your browser.');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        userLocation = { lat: latitude, lng: longitude };
        map.setView([latitude, longitude], 10);
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.circleMarker([latitude, longitude], {
          radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
          color: 'white', weight: 3
        }).addTo(map).bindPopup('Your Location');
      },
      err => {
        const msgs = { 1: 'Location access denied. Enable it in your browser settings.', 2: 'Position unavailable.', 3: 'Location request timed out.' };
        showToast(msgs[err.code] || 'Unable to get your location.');
      },
      { enableHighAccuracy: true }
    );
  }

  // â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 3959; // miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  let userLocation = null;

  function escHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function toggleFavorite(id) {
    id = String(id);
    const idx = favorites.indexOf(id);
    if (idx === -1) favorites.push(id);
    else favorites.splice(idx, 1);
    localStorage.setItem('chargefleet_favs', JSON.stringify(favorites));
    // Update star icons in DOM
    document.querySelectorAll(`.fav-btn[data-fav="${id}"]`).forEach(btn => {
      btn.textContent = favorites.includes(id) ? 'â˜…' : 'â˜†';
    });
    // Re-filter if favorites-only is active
    if (filters.favoritesOnly) { applyFilters(); }
  }

  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
  }

  // â”€â”€ URL Hash State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveStateToHash() {
    const params = new URLSearchParams();
    const center = map.getCenter();
    const zoom = map.getZoom();
    params.set('lat', center.lat.toFixed(4));
    params.set('lng', center.lng.toFixed(4));
    params.set('z', zoom);
    if (filters.vehicleClass !== 'all') params.set('vc', filters.vehicleClass);
    if (filters.connector !== 'all') params.set('ct', filters.connector);
    if (filters.minPower !== 150) params.set('pw', filters.minPower);
    if (filters.network !== 'all') params.set('net', filters.network);
    if (filters.facility !== 'all') params.set('fac', filters.facility);
    if (filters.funding !== 'all') params.set('fund', filters.funding);
    if (filters.status !== 'E') params.set('st', filters.status);
    if (filters.state !== 'all') params.set('state', filters.state);
    if (filters.search) params.set('q', filters.search);
    if (selectedStationId) params.set('sid', selectedStationId);
    window.history.replaceState(null, '', '#' + params.toString());
  }

  function loadStateFromHash() {
    const hash = window.location.hash.slice(1);
    if (!hash) return;
    const params = new URLSearchParams(hash);

    if (params.has('lat') && params.has('lng') && params.has('z')) {
      const lat = parseFloat(params.get('lat'));
      const lng = parseFloat(params.get('lng'));
      const z = parseInt(params.get('z'));
      if (Number.isFinite(lat) && Number.isFinite(lng) && Number.isFinite(z) &&
          lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180 && z >= 1 && z <= 18) {
        map.setView([lat, lng], z);
      }
    }
    if (params.has('vc')) {
      filters.vehicleClass = params.get('vc');
      activateChip('vehicleClass', filters.vehicleClass);
    }
    if (params.has('ct')) {
      filters.connector = params.get('ct');
      activateChip('connector', filters.connector);
    }
    if (params.has('pw')) {
      filters.minPower = parseInt(params.get('pw'));
      document.getElementById('powerSlider').value = filters.minPower;
      const v = filters.minPower;
      document.getElementById('powerValue').textContent = v >= 1000 ? `${(v/1000).toFixed(1)}+ MW` : `${v}+ kW`;
    }
    if (params.has('net')) {
      filters.network = params.get('net');
      activateChip('network', filters.network);
    }
    if (params.has('fac')) {
      filters.facility = params.get('fac');
      activateChip('facility', filters.facility);
    }
    if (params.has('fund')) {
      filters.funding = params.get('fund');
      activateChip('funding', filters.funding);
    }
    if (params.has('st')) {
      filters.status = params.get('st');
      activateChip('status', filters.status);
    }
    if (params.has('state')) {
      filters.state = params.get('state');
      activateChip('state', filters.state);
    }
    if (params.has('q')) {
      filters.search = params.get('q');
      document.getElementById('searchInput').value = filters.search;
    }
    if (params.has('sid')) {
      selectedStationId = parseInt(params.get('sid'));
    }
  }

  function activateChip(filterType, value) {
    document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(c => {
      c.classList.toggle('active', c.dataset.value === value);
    });
  }

  // Save state on map move and filter change
  let hashTimeout;
  function scheduleHashUpdate() {
    clearTimeout(hashTimeout);
    hashTimeout = setTimeout(saveStateToHash, 500);
  }

  // â”€â”€ Route Corridor Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let routeLayer = null;
  let routeStations = [];

  function initRouteSearch() {
    const tabLocation = document.getElementById('searchTabLocation');
    const tabRoute = document.getElementById('searchTabRoute');
    const panelLocation = document.getElementById('locationSearchPanel');
    const panelRoute = document.getElementById('routeSearchPanel');

    tabLocation.addEventListener('click', () => {
      tabLocation.style.background = 'var(--accent)';
      tabLocation.style.color = 'white';
      tabLocation.style.borderColor = 'var(--accent)';
      tabLocation.classList.add('active');
      tabRoute.style.background = 'var(--bg-card)';
      tabRoute.style.color = 'var(--text-dim)';
      tabRoute.style.borderColor = 'var(--border)';
      tabRoute.classList.remove('active');
      panelLocation.style.display = '';
      panelRoute.style.display = 'none';
      clearRoute();
    });

    tabRoute.addEventListener('click', () => {
      tabRoute.style.background = 'var(--accent)';
      tabRoute.style.color = 'white';
      tabRoute.style.borderColor = 'var(--accent)';
      tabRoute.classList.add('active');
      tabLocation.style.background = 'var(--bg-card)';
      tabLocation.style.color = 'var(--text-dim)';
      tabLocation.style.borderColor = 'var(--border)';
      tabLocation.classList.remove('active');
      panelLocation.style.display = 'none';
      panelRoute.style.display = '';
    });

    document.getElementById('routeSearchBtn').addEventListener('click', searchRoute);
    document.getElementById('routeDestination').addEventListener('keydown', e => {
      if (e.key === 'Enter') searchRoute();
    });
  }

  async function searchRoute() {
    const origin = document.getElementById('routeOrigin').value.trim();
    const dest = document.getElementById('routeDestination').value.trim();
    const radius = document.getElementById('routeRadius').value;
    const status = document.getElementById('routeStatus');

    if (!origin || !dest) {
      showToast('Enter both origin and destination.');
      return;
    }

    status.style.display = 'block';
    status.innerHTML = '<span style="color:var(--accent);">â³ Geocoding origin...</span>';

    try {
      // Geocode origin and destination
      const [originCoords, destCoords] = await Promise.all([
        geocodePlace(origin),
        geocodePlace(dest)
      ]);

      if (!originCoords || !destCoords) {
        status.innerHTML = '<span style="color:var(--red);">âŒ Could not find one or both locations. Try more specific addresses.</span>';
        return;
      }

      status.innerHTML = '<span style="color:var(--accent);">â³ Getting route from OSRM...</span>';

      // Get driving route from OSRM
      const routeUrl = `https://router.project-osrm.org/route/v1/driving/${originCoords.lng},${originCoords.lat};${destCoords.lng},${destCoords.lat}?overview=full&geometries=geojson`;
      const routeResp = await fetch(routeUrl);
      const routeData = await routeResp.json();

      if (!routeData.routes || routeData.routes.length === 0) {
        status.innerHTML = '<span style="color:var(--red);">âŒ No driving route found between these locations.</span>';
        return;
      }

      const route = routeData.routes[0];
      const routeCoords = route.geometry.coordinates; // [lng, lat] pairs
      const distMiles = (route.distance / 1609.34).toFixed(0);
      const durationHrs = (route.duration / 3600).toFixed(1);

      // Draw route on map
      clearRoute();
      const latLngs = routeCoords.map(c => [c[1], c[0]]);
      routeLayer = L.layerGroup();
      L.polyline(latLngs, { color: '#3b82f6', weight: 4, opacity: 0.7, dashArray: '8 6' }).addTo(routeLayer);
      L.circleMarker([originCoords.lat, originCoords.lng], { radius: 8, fillColor: '#10b981', fillOpacity: 1, color: 'white', weight: 2 })
        .bindPopup(`<strong>Origin:</strong> ${escHtml(origin)}`).addTo(routeLayer);
      L.circleMarker([destCoords.lat, destCoords.lng], { radius: 8, fillColor: '#ef4444', fillOpacity: 1, color: 'white', weight: 2 })
        .bindPopup(`<strong>Destination:</strong> ${escHtml(dest)}`).addTo(routeLayer);
      routeLayer.addTo(map);

      // Fit map to route
      const bounds = L.latLngBounds(latLngs);
      map.fitBounds(bounds, { padding: [50, 50] });

      status.innerHTML = `<span style="color:var(--accent);">â³ Finding chargers within ${radius} mi of route...</span>`;

      // Find stations near route by checking distance to polyline segments
      const radiusMi = parseFloat(radius);
      const nearbyStations = findStationsNearRoute(latLngs, radiusMi);

      // Highlight route stations
      routeStations = nearbyStations;
      filteredStations = nearbyStations;
      updateMarkers();
      updateStationList();
      updateMapInfo();

      status.innerHTML = `<span style="color:var(--green);">âœ… ${distMiles} mi route, ~${durationHrs} hrs â€” <strong>${nearbyStations.length} chargers</strong> within ${radius} mi</span>
        <button id="clearRouteBtn" style="display:block;margin-top:6px;padding:4px 12px;font-size:11px;background:var(--bg-card);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;">Clear Route</button>`;
      document.getElementById('clearRouteBtn').addEventListener('click', () => {
        clearRoute();
        applyFilters();
        status.style.display = 'none';
      });

    } catch (err) {
      console.error('Route search error:', err);
      status.innerHTML = `<span style="color:var(--red);">âŒ Route search failed: ${err.message}</span>`;
    }
  }

  async function geocodePlace(query) {
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`);
    const results = await resp.json();
    if (results.length > 0) {
      return { lat: parseFloat(results[0].lat), lng: parseFloat(results[0].lon) };
    }
    return null;
  }

  function findStationsNearRoute(routeLatLngs, radiusMiles) {
    // Sample route every ~5 points for performance
    const sampleRate = Math.max(1, Math.floor(routeLatLngs.length / 200));
    const samples = routeLatLngs.filter((_, i) => i % sampleRate === 0);

    return allStations.filter(s => {
      // Quick bounding box check first
      for (const pt of samples) {
        const dist = haversineDistance(s.latitude, s.longitude, pt[0], pt[1]);
        if (dist <= radiusMiles) return true;
      }
      return false;
    });
  }

  function clearRoute() {
    if (routeLayer) {
      map.removeLayer(routeLayer);
      routeLayer = null;
    }
    routeStations = [];
  }

  // â”€â”€ GeoJSON Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function exportGeoJSON() {
    if (filteredStations.length === 0) {
      showToast('No stations to export.');
      return;
    }
    const geojson = {
      type: 'FeatureCollection',
      features: filteredStations.map(s => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [s.longitude, s.latitude] },
        properties: {
          name: s.station_name,
          address: `${s.street_address}, ${s.city}, ${s.state} ${s.zip}`,
          network: s.ev_network,
          maxPowerKW: s._maxPower || null,
          dcFastPorts: s.ev_dc_fast_num || 0,
          connectors: (s.ev_connector_types || []).join(', '),
          vehicleClass: s.maximum_vehicle_class || null,
          facilityType: s.facility_type || null,
          status: s.status_code === 'E' ? 'Available' : s.status_code === 'P' ? 'Planned' : s.status_code,
          hours: s.access_days_time || null,
          pricing: s.ev_pricing || null,
          funding: (s.funding_sources || []).join(', ') || null,
          phone: s.station_phone || null,
          lastConfirmed: s.date_last_confirmed || null,
          afdcId: s.id
        }
      }))
    };
    const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/geo+json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chargefleet-stations-${new Date().toISOString().slice(0,10)}.geojson`;
    a.click();
    URL.revokeObjectURL(url);
    showToast(`Exported ${filteredStations.length} stations as GeoJSON.`);
  }

  // â”€â”€ Stats Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStats() {
    const stations = filteredStations.length > 0 ? filteredStations : allStations;
    const label = filteredStations.length > 0 && filteredStations.length < allStations.length ? 'filtered' : 'all';

    // Network breakdown
    const networks = {};
    const connectors = {};
    const powerBuckets = { '1MW+': 0, '350-999kW': 0, '150-349kW': 0, '50-149kW': 0, 'Unknown': 0 };
    const states = {};
    let totalPorts = 0;
    let plannedCount = 0;
    let neviCount = 0;

    stations.forEach(s => {
      const net = s.ev_network || 'Unknown';
      networks[net] = (networks[net] || 0) + 1;

      (s.ev_connector_types || []).forEach(c => {
        connectors[c] = (connectors[c] || 0) + 1;
      });

      const p = s._maxPower;
      if (p >= 1000) powerBuckets['1MW+']++;
      else if (p >= 350) powerBuckets['350-999kW']++;
      else if (p >= 150) powerBuckets['150-349kW']++;
      else if (p > 0) powerBuckets['50-149kW']++;
      else powerBuckets['Unknown']++;

      if (s.state) states[s.state] = (states[s.state] || 0) + 1;
      totalPorts += (s.ev_dc_fast_num || 0);
      if (s.status_code === 'P') plannedCount++;
      if (s.funding_sources?.includes('NEVI')) neviCount++;
    });

    // Sort networks by count
    const topNetworks = Object.entries(networks).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const maxNet = topNetworks[0]?.[1] || 1;

    // Sort states by count
    const topStates = Object.entries(states).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const maxState = topStates[0]?.[1] || 1;

    const connectorLabels = { 'TESLA': 'NACS', 'J1772COMBO': 'CCS', 'CHADEMO': 'CHAdeMO', 'J3271': 'MCS', 'J1772': 'J1772' };

    let html = `
      <div style="margin-bottom:12px;color:var(--text-dim);">Showing ${label} stations (${stations.length.toLocaleString()})</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
        <div style="background:var(--bg-card);padding:10px;border-radius:var(--radius);text-align:center;">
          <div style="font-size:18px;font-weight:700;color:var(--accent);">${stations.length.toLocaleString()}</div>
          <div style="font-size:10px;color:var(--text-dim);">Stations</div>
        </div>
        <div style="background:var(--bg-card);padding:10px;border-radius:var(--radius);text-align:center;">
          <div style="font-size:18px;font-weight:700;color:var(--green);">${totalPorts.toLocaleString()}</div>
          <div style="font-size:10px;color:var(--text-dim);">DC Fast Ports</div>
        </div>
        <div style="background:var(--bg-card);padding:10px;border-radius:var(--radius);text-align:center;">
          <div style="font-size:18px;font-weight:700;color:var(--purple);">${plannedCount.toLocaleString()}</div>
          <div style="font-size:10px;color:var(--text-dim);">Planned</div>
        </div>
        <div style="background:var(--bg-card);padding:10px;border-radius:var(--radius);text-align:center;">
          <div style="font-size:18px;font-weight:700;color:var(--cyan);">${neviCount.toLocaleString()}</div>
          <div style="font-size:10px;color:var(--text-dim);">NEVI Funded</div>
        </div>
      </div>

      <div style="font-size:12px;font-weight:600;color:var(--text-bright);margin-bottom:8px;">Power Distribution</div>
      ${Object.entries(powerBuckets).map(([label, count]) => {
        const pct = stations.length > 0 ? (count / stations.length * 100) : 0;
        const colors = { '1MW+': 'var(--red)', '350-999kW': 'var(--orange)', '150-349kW': 'var(--amber)', '50-149kW': 'var(--accent)', 'Unknown': 'var(--purple)' };
        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="width:80px;font-size:11px;color:var(--text-dim);">${label}</span>
          <div style="flex:1;height:14px;background:var(--bg-card);border-radius:3px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:${colors[label]};border-radius:3px;"></div>
          </div>
          <span style="width:40px;text-align:right;font-size:11px;color:var(--text);">${count}</span>
        </div>`;
      }).join('')}

      <div style="font-size:12px;font-weight:600;color:var(--text-bright);margin:12px 0 8px;">Top Networks</div>
      ${topNetworks.map(([net, count]) => {
        const pct = (count / maxNet * 100);
        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="width:80px;font-size:11px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escHtml(net)}">${escHtml(networkShort(net))}</span>
          <div style="flex:1;height:14px;background:var(--bg-card);border-radius:3px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:var(--accent);border-radius:3px;"></div>
          </div>
          <span style="width:40px;text-align:right;font-size:11px;color:var(--text);">${count}</span>
        </div>`;
      }).join('')}

      <div style="font-size:12px;font-weight:600;color:var(--text-bright);margin:12px 0 8px;">Top States</div>
      ${topStates.map(([st, count]) => {
        const pct = (count / maxState * 100);
        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="width:30px;font-size:11px;color:var(--text-dim);font-weight:600;">${st}</span>
          <div style="flex:1;height:14px;background:var(--bg-card);border-radius:3px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:var(--green);border-radius:3px;"></div>
          </div>
          <span style="width:40px;text-align:right;font-size:11px;color:var(--text);">${count}</span>
        </div>`;
      }).join('')}

      <div style="font-size:12px;font-weight:600;color:var(--text-bright);margin:12px 0 8px;">Connectors</div>
      ${Object.entries(connectors).sort((a,b) => b[1]-a[1]).map(([c, count]) => {
        return `<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-dim);margin-bottom:2px;">
          <span>${connectorLabels[c] || c}</span><span style="color:var(--text);">${count} stations</span>
        </div>`;
      }).join('')}
    `;

    document.getElementById('statsContent').innerHTML = html;
  }

  // â”€â”€ Print-friendly styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Add print CSS for exporting map views
  const printStyle = document.createElement('style');
  printStyle.textContent = '@media print { .sidebar, .legend, .map-info, .locate-btn, .sidebar-toggle, .loading-overlay { display: none !important; } .map-container { position: absolute; inset: 0; } #map { height: 100vh !important; } .header { position: static; } }';
  document.head.appendChild(printStyle);

  // â”€â”€ Connectivity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('online', () => {
    if (allStations.length === 0) {
      showToast('Back online â€” loading data...');
      loadData();
    }
  });

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
